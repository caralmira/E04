{% extends 'base.html' %}
{% load static %}
{% block meta %}
<title>Donation | Irama Kain</title>
{% endblock meta %}

{% block content %}
<html>
    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href= "{% static "/donation/css/donationhistory.css" %}">
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <style>
            
            .card-horizontal {
            display: flex;
            flex: auto;
            }
            .photo  {
                width: 200px;
                height: 200px;
            }
        </style>
    </head>
    <body>
        <script>
            async function refresh()    {
                $.get('/donation/json/', function (data) {
                    data.map((donasi) =>
                    $('#table-ongoing').append(
                        `<tr" class="mylayout" >
                            <div class="card">
                                <div class="card-horizontal">
                                    <div class="img-square-wrapper">
                                        <img class="photo" src="{% static "/donation/img/photo-holder.png" %}" alt="Card image cap">
                                    </div>
                                    <div class="card-body">
                                        <h4 class="card-title">Donasi ${donasi.fields.jenis_barang} </h4>
                                        <p class="card-text">Banyak (dalam kg): ${donasi.fields.amount}</p>
                                        <p class="card-text">Kontak: {{kontak}}</p>
                                        <p class="card-text">Alamat: {{alamat}}</p>
                                        <p class="card-text">Shipping method: ${donasi.fields.shipping_method}</p>
                                        <button type="submit" name="submit" class="button-selesai" data-id="${donasi.pk}" onclick = "selesai_donasi(${donasi.pk})">Selesai</button>   
                                        <button type="button" class="btn btn-info btn-lg" data-bs-toggle="modal" data-bs-target="#myModal${donasi.pk}">Edit</button>        

                                        <div class="modal fade" id="myModal${donasi.pk}" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h1 class="modal-title fs-5" id="createTaskModal">Edit Profile</h1>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="modalform" method="post">
                                                {% csrf_token %}
                                                <div class="mb-3">
                                                    <label for="donation-jenis" class="col-form-label">Jenis Barang</label>
                                                    <input type="text" class="form-control" id="donation-jenis${donasi.pk}" value= "${donasi.fields.jenis_barang}">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="donation-amount" class="col-form-label">Banyak (dalam kg)</label>
                                                    <input type="number" class="form-control" id="donation-amount${donasi.pk}"" method="post" value= "${donasi.fields.amount}">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="donation-ship" class="col-form-label">Shipping method</label>
                                                    <select class="form-control"  id="donation-ship${donasi.pk}" method="post">
                                                        <option value="Antar sendiri">Antar sendiri</option>
                                                        <option value="JNE">JNE</option>
                                                        <option value="POS INDONESIA">POS INDONESIA</option>
                                                        <option value="TIKI">TIKI</option>
                                                        <option value="SiCepat">SiCepat</option>
                                                        <option value="J&T">J&T</option>
                                                    </select>
                                                </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="submit" value="Save" name="submit" class ="btn btn-primary" onclick = "edit_donasi(${donasi.pk})"><a >Save</a></button>                                             </div>
                                        </div>
                                        </div>
                                    </div>                      
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">Last updated on ${donasi.fields.waktu_isi}</small>
                                </div>
                            </div>
                    </tr>`
                    )
                    );
                });
                console.log("did that")
                
                $.get('/donation/history/', function (data) {
                    data.map((donasi2) =>
                    $('#table-history').append(
                        `<tr" class="mylayout" >   
                            <div class="card">
                                <div class="card-horizontal">
                                    <div class="img-square-wrapper">
                                        <img class="photo" src="{% static "/donation/img/photo-holder.png" %}" alt="Card image cap">
                                    </div>
                                    <div class="card-body">
                                        <h4 class="card-title">Donasi ${donasi2.fields.jenis_barang} </h4>
                                        <p class="card-text">Banyak (dalam kg): ${donasi2.fields.amount}</p>
                                        <p class="card-text">Kontak: {{kontak}}</p>
                                        <p class="card-text">Alamat: {{alamat}}</p>
                                        <p class="card-text">Shipping method: ${donasi2.fields.shipping_method}</p>                                    
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">Last updated on ${donasi2.fields.waktu_isi}</small>
                                </div>
                            </div>
                    </tr>`
                    ))
                    
                });
            }
            function edit_donasi(pk2){
                console.log("ini pk2 " + (pk2))
                event.preventDefault();
                $("#myModal").modal('show');
                console.log("awal works")
                var linkjenis_barang = "#donation-jenis"+pk2
                var link_amount = "#donation-amount"+pk2
                var link_ship = "#donation-ship"+pk2
                
                var url = "/donation/edit/" + pk2
                const formData = {
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                    jenis_barang: $(linkjenis_barang).val(),
                    amount: $(link_amount).val(),
                    shipping_method: $(link_ship).val(),
                };
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: formData,
                    success: function(response) {
                        alert("Data berhasil diubah!")
                        console.log("works")
                        $('#table-ongoing').empty()
                        refresh()
                        $("#modalId").modal('hide'); 
                        $('.modal-backdrop').remove();
                        $('body').attr("style", "overflow:auto")
                    }
                    })
                    
                }

            function selesai_donasi(pk2){
                event.preventDefault();
                console.log("awal works")
                console.log("ini pk2: " + pk2)

                var url = "/donation/done/" + pk2
                const formData = {
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                };
                if(confirm("Yakin ingin menyelesaikan donasi?")){
                    $.ajax({
                    type: 'POST',
                    url: url,
                    data: formData,
                    success: function(response) {
                        console.log("works")
                        console.log(response.poin)
                        $('#table-ongoing').empty()
                        $('#table-history').empty()
                        document.getElementById("mycoins").innerHTML = "My points: " + response.poin ;
                        refresh()
                    }
                    }).done(function (data) {
                    alert("selesai donasi!")
                    });
                    };
                }
            refresh()
        </script>
        <!-- NAVBAR -->
        <nav class="navbar navbar-expand-lg bg-light">
            <div class="container-fluid">
              <a class="navbar-brand" href="{% url 'Home:show_home' %}">Irama Kain</a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarText">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                  <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="{% url 'donation:show-donation' %} ">My Donations</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">Shop</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="{% url 'faq:index' %}" >FaQ</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#">Partnership</a>
                  </li>
                </ul>
                <div class="d-flex">
                    <a class="nav-link" href="#" style="margin-right: 20px">
                        <img class="me-2 p-2 nav-item" src="../static/donation/img/cart.png" style="width: 45px; height:45px; ">
                    </a>
                    <div class="containers col p-2" style="padding-top: 12px; margin-left: 10px; margin-right: 30px;">
                        <img src="../static/profile/img/Coins.png" style="display: inline; width: 25px; height: 25px;">
                        <p class="nav-link" style="display: inline; font-size: 16px;">{{poin}}</p>
                    </div>
                    <a class="p-2 nav-link" href="{% url 'Authentication:logout-user' %}">Sign Out</a>
                </div>
              </div>
            </div>
          </nav>
          <!-- END NAVBAR -->
        <div class="donation">
            <div class = "row photo-group">
                
                <div class="col sea-group">
                <div class="row" style="float:right; width:600px; padding-right:20px">
                    <div class="col" id="batasAtas"></div>
                    <div class="w-100"></div>
                    <div class="col sea">
                        <div class="linearmove waveshort">
                            <img class="sea-item" src="../static/donation/img/cloth.png">
                            <img class= "box" src="../static/donation/img/wave1.png">
                        </div>
                        <div class="linearmove wave2">
                            <img class="sea-item" src="../static/donation/img/bottle.png">
                            <img class="sea-item" src="../static/donation/img/fishbone.png">
                        </div>
                        <div class="linearmove wave4">
                            <img class="box" src="../static/donation/img/wave1.png">
                        </div>
                        <div class="linearmove">
                            <img class="sea-item" src="../static/donation/img/plastic.png">
                            <img class= "box" src="../static/donation/img/wave2.png">
                        </div>
                        
                        <div class="linearmove wave3">
                            <img class="sea-item" src="../static/donation/img/sandal.png">
                            <img class= "box" src="../static/donation/img/wave3.png">
                        </div>
                        
                        
                        <!-- <div class="linearmove">
                            <img class="box wave3" src="../static/donation/img/wave3.png">
                        </div>
                        <div class="linearmove waveshort">
                            <img class="box wave3" src="../static/donation/img/cloth.png">
                        </div> -->
                    </div>
                    <div class="w-100"></div>
                    <div class="col" id="batasBawah"></div>
                </div>
                </div>
                <div class="col text-group">
                    <p class="text-photo">
                        Microplastics are estimated to enter the ocean each year of 14 million tonnes. 
                    </p>
                    <p class="text-photo">
                        About 16-35% microplastics released to the oceans are from synthetic textiles which is caused by the vast fashion production in the recent times. (www.eea.europa.eu)
                    </p>
                    <p class="text-photo">
                        A sustainable fashion production is needed for reducing the release of microplastic toxins to the oceans as well as recycling clothes!
                    </p>
                    <p class="text-photo" style="color:#7335C2;">
                        Irama Kain exists to provide this act for a better and healthier ocean!
                    </p>
                </div>    
                
            </div> 
            <div class = "ongoing-donation" style="display:block; ">
                <h2>
                    My ongoing donation
                </h2>
                <table class="ongoingTable">
                    <tr id="table-ongoing" class= "mylayout">

                    </tr>   
                    
                </table>

            </div>
            <div class = 'donation-history'></div>
                <h2>
                    My donation history
                </h2>
                <table class="alltimeTable">
                    <tr id="table-history" class= "mylayout">
                    </tr>   
                </table>
                
            </div>
        </div>
       
    </body>
</html>
{% endblock content %}